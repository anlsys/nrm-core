<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="">{-# LANGUAGE ScopedTypeVariables #-}
{-# LANGUAGE ViewPatterns #-}

-- |
-- Module      : NRM.Codegen
-- Copyright   : (c) 2019, UChicago Argonne, LLC.
-- License     : BSD3
-- Maintainer  : fre@freux.fr
module NRM.Codegen
  ( main,
    upstreamPubSchema,
    upstreamReqSchema,
    upstreamRepSchema,
    downstreamEventSchema,
    manifestSchema,
    configurationSchema,
    libnrmHeader,
    licenseC,
    licenseDhall,
    licenseYaml,
  )
where

import qualified CPD.Values
import Codegen.CHeader
import Codegen.Dhall
import Codegen.Schema (generatePretty)
import Codegen.Schema as CS
import Data.Aeson.Encode.Pretty as AP (encodePretty)
import Data.Default
import Data.JSON.Schema as S
import qualified Data.Map as DM
import Data.Yaml as Y
import Dhall
import qualified Dhall.Core as Dhall
import Dhall.Import as Dhall
import Dhall.JSON as DJ
import qualified Dhall.Lint as Lint
import qualified Dhall.Parser
import qualified Dhall.TypeCheck as Dhall
import qualified NRM.Classes.Examples as Examples
import qualified NRM.Manifest.Examples ()
import NRM.Messaging
import qualified NRM.Types.Configuration as C
import qualified NRM.Types.Manifest as MI
import NRM.Types.Messaging.DownstreamEvent
import qualified NRM.Types.Messaging.DownstreamEvent as Down (Event (..))
import NRM.Types.Messaging.UpstreamPub
import NRM.Types.Messaging.UpstreamRep
import NRM.Types.Messaging.UpstreamReq
import NeatInterpolation
import Protolude hiding (Rep)
import System.Directory
import Prelude (String)

-- | The main code generation binary.
main :: IO ()
main = do
  (toS -&gt; prefix) : _ &lt;- getArgs
  putText &quot;Codegen: LibNRM C headers.&quot;
  putText $ &quot;  Writing libnrm header to &quot; &lt;&gt; prefix &lt;&gt; &quot;/nrm_messaging.h&quot;
  writeFile (toS $ prefix &lt;&gt; &quot;/nrm_messaging.h&quot;) $ toS (licenseC &lt;&gt; &quot;\n\n&quot; &lt;&gt; libnrmVars &lt;&gt; &quot;\n\n&quot; &lt;&gt; libnrmHeader)
  putText &quot;Codegen: JSON schemas&quot;
  verboseWriteSchema prefix &quot;upstreamPub&quot; upstreamPubSchema
  verboseWriteSchema prefix &quot;upstreamRep&quot; upstreamRepSchema
  verboseWriteSchema prefix &quot;upstreamReq&quot; upstreamReqSchema
  verboseWriteSchema prefix &quot;downstreamEvent&quot; downstreamEventSchema
  verboseWriteSchema prefix &quot;manifestSchema&quot; manifestSchema
  verboseWriteSchema prefix &quot;configurationSchema&quot; manifestSchema
  generateResources prefix
  where
    verboseWriteSchema :: Text -&gt; Text -&gt; Text -&gt; IO ()
    verboseWriteSchema prefix desc sch = do
      putText $ toS (&quot;  Writing schema for &quot; &lt;&gt; toS desc &lt;&gt; &quot; to &quot; &lt;&gt; fp)
      writeFile (toS fp) sch
      where
        fp = prefix &lt;&gt; &quot;/&quot; &lt;&gt; desc &lt;&gt; &quot;.json&quot;

-- | The upstream Request schema.
upstreamReqSchema :: Text
upstreamReqSchema = generatePretty (Proxy :: Proxy Req)

-- | The upstream Reply schema.
upstreamRepSchema :: Text
upstreamRepSchema = generatePretty (Proxy :: Proxy Rep)

-- | The upstream Pub schema.
upstreamPubSchema :: Text
upstreamPubSchema = generatePretty (Proxy :: Proxy Pub)

-- | The downstream Event schema.
downstreamEventSchema :: Text
downstreamEventSchema = generatePretty (Proxy :: Proxy Event)

-- | The manifest schema.
manifestSchema :: Text
manifestSchema = toS $ AP.encodePretty $ CS.toAeson $ S.schema (Proxy :: Proxy MI.Manifest)

-- | The configuration schema.
configurationSchema :: Text
configurationSchema = toS $ AP.encodePretty $ CS.toAeson $ S.schema (Proxy :: Proxy C.Cfg)

-- | The libnrm C header.
libnrmHeader :: Text
libnrmHeader = toS $ toCHeader (Proxy :: Proxy Down.Event)

-- | A license for C headers.
licenseC :: Text
licenseC =
  [text|
    /*******************************************************************************
     * Copyright 2019 UChicago Argonne, LLC.
     * (c.f. AUTHORS, LICENSE)
     *
     * SPDX-License-Identifier: BSD-3-Clause
    *******************************************************************************
     *
     *    this file is generated, modifications will be erased.
    */

  |]

-- | A license for Yaml files
licenseYaml :: Text
licenseYaml =
  [text|
</span><span class="hs-cpp">    # ******************************************************************************
    #  Copyright 2019 UChicago Argonne, LLC.
    #  (c.f. AUTHORS, LICENSE)
    #
    #  SPDX-License-Identifier: BSD-3-Clause
    # ******************************************************************************
    #
    #     this file is generated, modifications will be erased.
    #
</span><span>
</span><a name="line-137"></a><span>  </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span>
</span><a name="line-138"></a><span>
</span><a name="line-139"></a><span class="hs-comment">-- | A license for Dhall files</span><span>
</span><a name="line-140"></a><span class="hs-identifier">licenseDhall</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-141"></a><a name="licenseDhall"><a href="NRM.Codegen.html#licenseDhall"><span class="hs-identifier">licenseDhall</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-142"></a><span>  </span><span class="">[text|
    -- ******************************************************************************
    --  Copyright 2019 UChicago Argonne, LLC.
    --  (c.f. AUTHORS, LICENSE)
    --
    --  SPDX-License-Identifier: BSD-3-Clause
    -- ******************************************************************************
    --
    --     this file is generated, modifications will be erased.
    --

  |]</span><span>
</span><a name="line-154"></a><span>
</span><a name="line-155"></a><span class="hs-keyword">data</span><span> </span><a name="KnownType"><a href="NRM.Codegen.html#KnownType"><span class="hs-identifier">KnownType</span></a></a><span>
</span><a name="line-156"></a><span>  </span><span class="hs-glyph">=</span><span> </span><a name="Cfg"><a href="NRM.Codegen.html#Cfg"><span class="hs-identifier">Cfg</span></a></a><span>
</span><a name="line-157"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a name="Manifest"><a href="NRM.Codegen.html#Manifest"><span class="hs-identifier">Manifest</span></a></a><span>
</span><a name="line-158"></a><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Bounded</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Read</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span>
</span><a name="line-160"></a><span class="hs-identifier">dhallType</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NRM.Codegen.html#KnownType"><span class="hs-identifier hs-type">KnownType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Dhall.Expr</span><span> </span><span class="hs-identifier hs-type">Dhall.Parser.Src</span><span> </span><span class="hs-identifier hs-type">Dhall.Import</span><span>
</span><a name="line-161"></a><a name="dhallType"><a href="NRM.Codegen.html#dhallType"><span class="hs-identifier">dhallType</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-162"></a><span>  </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier">Dhall.absurd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-163"></a><span>    </span><a href="NRM.Codegen.html#Cfg"><span class="hs-identifier hs-var">Cfg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Dhall.expected</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Dhall.auto</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Dhall.Type</span><span> </span><a href="NRM.Types.Configuration.html#Cfg"><span class="hs-identifier hs-type">C.Cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>    </span><a href="NRM.Codegen.html#Manifest"><span class="hs-identifier hs-var">Manifest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Dhall.expected</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Dhall.auto</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Dhall.Type</span><span> </span><a href="NRM.Types.Manifest.html#Manifest"><span class="hs-identifier hs-type">MI.Manifest</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">sandwich</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Semigroup</span><span> </span><a href="#local-6989586621680771087"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621680771087"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680771087"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680771087"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621680771087"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-167"></a><a name="sandwich"><a href="NRM.Codegen.html#sandwich"><span class="hs-identifier">sandwich</span></a></a><span> </span><a name="local-6989586621680771294"><a href="#local-6989586621680771294"><span class="hs-identifier">a</span></a></a><span> </span><a name="local-6989586621680771295"><a href="#local-6989586621680771295"><span class="hs-identifier">b</span></a></a><span> </span><a name="local-6989586621680771296"><a href="#local-6989586621680771296"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680771294"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771296"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771295"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-168"></a><span>
</span><a name="line-169"></a><span class="hs-identifier">typeFile</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NRM.Codegen.html#KnownType"><span class="hs-identifier hs-type">KnownType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-170"></a><a name="typeFile"><a href="NRM.Codegen.html#typeFile"><span class="hs-identifier">typeFile</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="NRM.Codegen.html#sandwich"><span class="hs-identifier hs-var">sandwich</span></a><span> </span><span class="hs-string">&quot;types/&quot;</span><span> </span><span class="hs-string">&quot;.dhall&quot;</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-identifier">getDefault</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NRM.Codegen.html#KnownType"><span class="hs-identifier hs-type">KnownType</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Dhall.Expr</span><span> </span><span class="hs-identifier hs-type">Dhall.Parser.Src</span><span> </span><a href="#local-6989586621680771086"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-173"></a><a name="getDefault"><a href="NRM.Codegen.html#getDefault"><span class="hs-identifier">getDefault</span></a></a><span> </span><a name="local-6989586621680771297"><a href="#local-6989586621680771297"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-174"></a><span>  </span><span class="hs-identifier">Dhall.absurd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680771297"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-175"></a><span>    </span><a href="NRM.Codegen.html#Cfg"><span class="hs-identifier hs-var">Cfg</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">embed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">injectWith</span><span> </span><span class="hs-identifier hs-var">defaultInterpretOptions</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">def</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NRM.Types.Configuration.html#Cfg"><span class="hs-identifier hs-type">C.Cfg</span></a><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span>    </span><a href="NRM.Codegen.html#Manifest"><span class="hs-identifier hs-var">Manifest</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">embed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">injectWith</span><span> </span><span class="hs-identifier hs-var">defaultInterpretOptions</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">def</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="NRM.Types.Manifest.html#Manifest"><span class="hs-identifier hs-type">MI.Manifest</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span>
</span><a name="line-178"></a><span class="hs-identifier">generateResources</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-179"></a><a name="generateResources"><a href="NRM.Codegen.html#generateResources"><span class="hs-identifier">generateResources</span></a></a><span> </span><a name="local-6989586621680771298"><a href="#local-6989586621680771298"><span class="hs-identifier">prefix</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-180"></a><span>  </span><span class="hs-identifier hs-var">putText</span><span> </span><span class="hs-string">&quot;Codegen: Dhall types.&quot;</span><span>
</span><a name="line-181"></a><span>  </span><a href="NRM.Codegen.html#typeToFile"><span class="hs-identifier hs-var">typeToFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">[</span><a href="CPD.Values.html#Measurement"><span class="hs-identifier hs-type">CPD.Values.Measurement</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771298"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;/types/CPDMeasurements.dhall&quot;</span><span>
</span><a name="line-182"></a><span>  </span><a href="NRM.Codegen.html#typeToFile"><span class="hs-identifier hs-var">typeToFile</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><span class="hs-special">[</span><a href="CPD.Values.html#Action"><span class="hs-identifier hs-type">CPD.Values.Action</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771298"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;/types/CPDActions.dhall&quot;</span><span>
</span><a name="line-183"></a><span>  </span><span class="hs-comment">--typeToFile (Proxy :: Proxy CPD.Core.Problem) $ toS prefix &lt;&gt; &quot;/types/CPDProblem.dhall&quot;</span><span>
</span><a name="line-184"></a><span>  </span><span class="hs-identifier hs-var">for_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">minBound</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680771315"><a href="#local-6989586621680771315"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680771316"><a href="#local-6989586621680771316"><span class="hs-identifier">dest</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771298"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="NRM.Codegen.html#typeFile"><span class="hs-identifier hs-var">typeFile</span></a><span> </span><a href="#local-6989586621680771315"><span class="hs-identifier hs-var">t</span></a><span>
</span><a name="line-186"></a><span>    </span><span class="hs-identifier hs-var">putText</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;  Writing type for &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621680771315"><span class="hs-identifier hs-var">t</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot; to &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771316"><span class="hs-identifier hs-var">dest</span></a><span>
</span><a name="line-187"></a><span>    </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621680771316"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">)</span><span>
</span><a name="line-188"></a><span>    </span><a href="Codegen.Dhall.html#writeOutput"><span class="hs-identifier hs-var">writeOutput</span></a><span> </span><a href="NRM.Codegen.html#licenseDhall"><span class="hs-identifier hs-var">licenseDhall</span></a><span> </span><a href="#local-6989586621680771316"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-special">(</span><a href="NRM.Codegen.html#dhallType"><span class="hs-identifier hs-var">dhallType</span></a><span> </span><a href="#local-6989586621680771315"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>  </span><span class="hs-identifier hs-var">putText</span><span> </span><span class="hs-string">&quot;Codegen: defaults.&quot;</span><span>
</span><a name="line-190"></a><span>  </span><span class="hs-identifier hs-var">for_</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-var">minBound</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="hs-identifier hs-var">maxBound</span><span class="hs-special">]</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><a name="local-6989586621680771317"><a href="#local-6989586621680771317"><span class="hs-identifier">defaultType</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-191"></a><span>    </span><span class="hs-identifier hs-var">Dhall.load</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lint.lint</span><span> </span><span class="hs-special">(</span><a href="NRM.Codegen.html#getDefault"><span class="hs-identifier hs-var">getDefault</span></a><span> </span><a href="#local-6989586621680771317"><span class="hs-identifier hs-var">defaultType</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>      </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621680771299"><span class="hs-identifier hs-var">exprToDir</span></a><span> </span><span class="hs-string">&quot;defaults/&quot;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621680771317"><span class="hs-identifier hs-var">defaultType</span></a><span class="hs-special">)</span><span>
</span><a name="line-193"></a><span>  </span><span class="hs-identifier hs-var">putText</span><span> </span><span class="hs-string">&quot;Codegen: examples.&quot;</span><span>
</span><a name="line-194"></a><span>  </span><span class="hs-identifier hs-var">for_</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DM.toList</span><span> </span><span class="hs-special">(</span><a href="NRM.Classes.Examples.html#examples"><span class="hs-identifier hs-var">Examples.examples</span></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Map</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="NRM.Types.Manifest.html#Manifest"><span class="hs-identifier hs-type">MI.Manifest</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621680771318"><a href="#local-6989586621680771318"><span class="hs-identifier">defName</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680771319"><a href="#local-6989586621680771319"><span class="hs-identifier">defValue</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-identifier hs-var">Dhall.load</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Lint.lint</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">Dhall.absurd</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier">embed</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">injectWith</span><span> </span><span class="hs-identifier hs-var">defaultInterpretOptions</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680771319"><span class="hs-identifier hs-var">defValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-196"></a><span>      </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><a href="#local-6989586621680771299"><span class="hs-identifier hs-var">exprToDir</span></a><span> </span><span class="hs-string">&quot;examples/&quot;</span><span> </span><a href="#local-6989586621680771318"><span class="hs-identifier hs-var">defName</span></a><span>
</span><a name="line-197"></a><span>  </span><span class="hs-keyword">where</span><span>
</span><a name="line-198"></a><span>    </span><a name="local-6989586621680771299"><a href="#local-6989586621680771299"><span class="hs-identifier">exprToDir</span></a></a><span> </span><a name="local-6989586621680771302"><a href="#local-6989586621680771302"><span class="hs-identifier">dir</span></a></a><span> </span><a name="local-6989586621680771303"><a href="#local-6989586621680771303"><span class="hs-identifier">defName</span></a></a><span> </span><a name="local-6989586621680771304"><a href="#local-6989586621680771304"><span class="hs-identifier">expr</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-199"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680771305"><a href="#local-6989586621680771305"><span class="hs-identifier">dest</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680771306"><a href="#local-6989586621680771306"><span class="hs-identifier">destJ</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680771307"><a href="#local-6989586621680771307"><span class="hs-identifier">destY</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680771301"><span class="hs-identifier hs-var">mkPaths</span></a><span> </span><a href="#local-6989586621680771302"><span class="hs-identifier hs-var">dir</span></a><span> </span><a href="#local-6989586621680771303"><span class="hs-identifier hs-var">defName</span></a><span>
</span><a name="line-200"></a><span>      </span><span class="hs-identifier hs-var">DJ.dhallToJSON</span><span> </span><a href="#local-6989586621680771304"><span class="hs-identifier hs-var">expr</span></a><span> </span><span class="hs-operator hs-var">&amp;</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><a name="line-201"></a><span>        </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621680771308"><a href="#local-6989586621680771308"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">die</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;horrible internal dhall error: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621680771308"><span class="hs-identifier hs-var">e</span></a><span>
</span><a name="line-202"></a><span>        </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621680771309"><a href="#local-6989586621680771309"><span class="hs-identifier">jsonValue</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-203"></a><span>          </span><span class="hs-identifier hs-var">putText</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;  Writing default for &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771303"><span class="hs-identifier hs-var">defName</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot; to &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771305"><span class="hs-identifier hs-var">dest</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot;.&quot;</span><span>
</span><a name="line-204"></a><span>          </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771305"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">)</span><span>
</span><a name="line-205"></a><span>          </span><a href="Codegen.Dhall.html#writeOutput"><span class="hs-identifier hs-var">writeOutput</span></a><span>
</span><a name="line-206"></a><span>            </span><a href="NRM.Codegen.html#licenseDhall"><span class="hs-identifier hs-var">licenseDhall</span></a><span>
</span><a name="line-207"></a><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771305"><span class="hs-identifier hs-var">dest</span></a><span class="hs-special">)</span><span>
</span><a name="line-208"></a><span>            </span><a href="#local-6989586621680771304"><span class="hs-identifier hs-var">expr</span></a><span>
</span><a name="line-209"></a><span>          </span><span class="hs-identifier hs-var">writeFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771306"><span class="hs-identifier hs-var">destJ</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">AP.encodePretty</span><span> </span><a href="#local-6989586621680771309"><span class="hs-identifier hs-var">jsonValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-210"></a><span>          </span><span class="hs-identifier hs-var">writeFile</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771307"><span class="hs-identifier hs-var">destY</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="NRM.Codegen.html#licenseYaml"><span class="hs-identifier hs-var">licenseYaml</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Y.encode</span><span> </span><a href="#local-6989586621680771309"><span class="hs-identifier hs-var">jsonValue</span></a><span class="hs-special">)</span><span>
</span><a name="line-211"></a><span>    </span><a name="local-6989586621680771300"><a href="#local-6989586621680771300"><span class="hs-identifier">resourcePath</span></a></a><span> </span><a name="local-6989586621680771310"><a href="#local-6989586621680771310"><span class="hs-identifier">dir</span></a></a><span> </span><a name="local-6989586621680771311"><a href="#local-6989586621680771311"><span class="hs-identifier">defName</span></a></a><span> </span><a name="local-6989586621680771312"><a href="#local-6989586621680771312"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771298"><span class="hs-identifier hs-var">prefix</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771310"><span class="hs-identifier hs-var">dir</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771311"><span class="hs-identifier hs-var">defName</span></a><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621680771312"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-212"></a><span>    </span><a name="local-6989586621680771301"><a href="#local-6989586621680771301"><span class="hs-identifier">mkPaths</span></a></a><span> </span><a name="local-6989586621680771313"><a href="#local-6989586621680771313"><span class="hs-identifier">dir</span></a></a><span> </span><a name="local-6989586621680771314"><a href="#local-6989586621680771314"><span class="hs-identifier">defName</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-213"></a><span>      </span><span class="hs-special">(</span><span> </span><a href="#local-6989586621680771300"><span class="hs-identifier hs-var">resourcePath</span></a><span> </span><a href="#local-6989586621680771313"><span class="hs-identifier hs-var">dir</span></a><span> </span><a href="#local-6989586621680771314"><span class="hs-identifier hs-var">defName</span></a><span> </span><span class="hs-string">&quot;.dhall&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-214"></a><span>        </span><a href="#local-6989586621680771300"><span class="hs-identifier hs-var">resourcePath</span></a><span> </span><a href="#local-6989586621680771313"><span class="hs-identifier hs-var">dir</span></a><span> </span><a href="#local-6989586621680771314"><span class="hs-identifier hs-var">defName</span></a><span> </span><span class="hs-string">&quot;.json&quot;</span><span class="hs-special">,</span><span>
</span><a name="line-215"></a><span>        </span><a href="#local-6989586621680771300"><span class="hs-identifier hs-var">resourcePath</span></a><span> </span><a href="#local-6989586621680771313"><span class="hs-identifier hs-var">dir</span></a><span> </span><a href="#local-6989586621680771314"><span class="hs-identifier hs-var">defName</span></a><span> </span><span class="hs-string">&quot;.yaml&quot;</span><span>
</span><a name="line-216"></a><span>      </span><span class="hs-special">)</span><span>
</span><a name="line-217"></a><span>
</span><a name="line-218"></a><span class="hs-identifier">typeToFile</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Interpret</span><span> </span><a href="#local-6989586621680771085"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621680771085"><span class="hs-identifier hs-type">x</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-219"></a><a name="typeToFile"><a href="NRM.Codegen.html#typeToFile"><span class="hs-identifier">typeToFile</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Proxy</span><span> </span><a href="#local-6989586621680771320"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span> </span><a name="local-6989586621680771321"><a href="#local-6989586621680771321"><span class="hs-identifier">fp</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-220"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680771322"><a href="#local-6989586621680771322"><span class="hs-identifier">destCPD</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680771321"><span class="hs-identifier hs-var">fp</span></a><span>
</span><a name="line-221"></a><span>  </span><span class="hs-identifier hs-var">putText</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-string">&quot;  Writing types for CPD format. &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-string">&quot; to &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621680771322"><span class="hs-identifier hs-var">destCPD</span></a><span>
</span><a name="line-222"></a><span>  </span><span class="hs-identifier hs-var">createDirectoryIfMissing</span><span> </span><span class="hs-identifier hs-var">True</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">takeDirectory</span><span> </span><a href="#local-6989586621680771322"><span class="hs-identifier hs-var">destCPD</span></a><span class="hs-special">)</span><span>
</span><a name="line-223"></a><span>  </span><a href="Codegen.Dhall.html#writeOutput"><span class="hs-identifier hs-var">writeOutput</span></a><span>
</span><a name="line-224"></a><span>    </span><a href="NRM.Codegen.html#licenseDhall"><span class="hs-identifier hs-var">licenseDhall</span></a><span>
</span><a name="line-225"></a><span>    </span><a href="#local-6989586621680771322"><span class="hs-identifier hs-var">destCPD</span></a><span>
</span><a name="line-226"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier">Dhall.expected</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Dhall.auto</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Dhall.Type</span><span> </span><a href="#local-6989586621680771320"><span class="hs-identifier hs-type">x</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-227"></a></pre></body></html>