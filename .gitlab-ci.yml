stages:
  - source
  - rawbuild
  - lib
  - bin-so
  - codegen
  - libnrm
  - linked
  - integration

ormolu:
  stage: source
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell --pure -E '
        let pkgs = (import ./.);
        in pkgs.mkShell {
          buildInputs = [pkgs.fd pkgs.ormolu];
          shellHook =
            "export LOCALE_ARCHIVE=${pkgs.glibcLocales}/lib/locale/locale-archive \n" +
            "export LANG=en_US.UTF-8";
        }
      ' --run bash <<< '
        RETURN=0
        cd hsnrm
        for F in $(fd -e hs); do
          ormolu -o -XTypeApplications -m check $F
          if [ $? -ne 0 ]; then
            echo "[!] $F does not pass ormolu haskell format check." >&2
            RETURN=1
          fi
        done
        if [ $RETURN -ne 0 ]; then exit 1; fi
      '

hlint:
  stage: source
  tags:
    - kvm
    - nix
  script:
    - nix-shell --pure -p '(import ./.).hlint' --run bash <<< 'hlint hsnrm/ --hint=./.hlint.yaml'

black:
  stage: source
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell --pure -p '(import ./.).nrmPythonPackages.black' --run bash <<< '
        black pynrm/bin/* --check
        black pynrm/nrm/*.py --check
      '

clang-format:
  stage: source
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell --pure -p '(import ./.).fd' '(import ./.).clang-tools' --run bash <<< '
        RETURN=0
        cd libnrm
        for F in $(fd -e c); do
          clang-format < $F | cmp -s $F -
          if [ $? -ne 0 ]; then
            echo "[!] $F does not pass clang-format format check." >&2
            RETURN=1
          fi
        done
        if [ $RETURN -ne 0 ]; then exit 1; fi
      '

raw-build-libnrm:
  stage: rawbuild
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell -E '
        let pkgs = (import ./default.nix);
        in pkgs.libnrm.overrideAttrs (o:{
          preBuild="";
        })
      ' --run bash <<< '
        cd libnrm
        ./autogen.sh
        ./configure --enable-pmpi CC=mpicc FC=mpifort CFLAGS=-fopenmp
        make
      '


nix-build-nrm.so:
  stage: lib
  tags:
    - kvm
    - nix
  script: nix-build -A haskellPackages.nrmlib --no-build-output

nix-build-binaries:
  stage: bin-so
  tags:
    - kvm
    - nix
  script: nix-build -A haskellPackages.nrmbin --no-build-output

check-vendored-resources:
  stage: codegen
  tags:
    - kvm
    - nix
  script:
    - "echo 'check: are vendored resources up to date?'"
    - mkdir temp
    - "$(nix-build -A haskellPackages.nrmbin)/bin/codegen temp/"
    - diff -r temp resources

nix-build-resources:
  stage: codegen
  tags:
    - kvm
    - nix
  script: nix-build -A resources --no-build-output

nix-build-libnrm:
  stage: libnrm
  tags:
    - kvm
    - nix
  script: nix-build -A libnrm --no-build-output

nix-build-pynrm:
  stage: linked
  tags:
    - kvm
    - nix
  script: nix-build -A pynrm --no-build-output

nix-build-app-stream:
  stage: linked
  tags:
    - kvm
    - nix
  script: nix-build -A stream --no-build-output

nix-build-app-stream-raw:
  stage: linked
  tags:
    - kvm
    - nix
  script: nix-build -A stream-raw --no-build-output

nix-build-nrmFull:
  stage: linked
  tags:
    - integration
  script: nix-build -A nrm --no-build-output

dhrun-hello:
  stage: integration
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell --pure -p '(import ./.).nrm' -p '(import ./.).dhrun' --run "dhrun run --verbose" <<< '
        let all = ./dev/dhrun/all-tests.dh
          "../dev/dhrun/assets/"
          "../resources/defaults/Cfg.dhall // { verbose=<Normal|Verbose|Debug>.Debug }"
          "../resources/examples/"
        in all.hello
      '

dhrun-exitcode:
  stage: integration
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell --pure -p '(import ./.).nrm' -p '(import ./.).dhrun' --run "dhrun run --verbose" <<< '
        let all = ./dev/dhrun/all-tests.dh
          "../dev/dhrun/assets/"
          "../resources/defaults/Cfg.dhall // { verbose=<Normal|Verbose|Debug>.Debug }"
          "../resources/examples/"
        in all.exitcode
      '

dhrun-listen:
  stage: integration
  tags:
    - kvm
    - nix
  script:
    - |
      nix-shell --pure -p '(import ./.).nrm' -p '(import ./.).dhrun' --run "dhrun run --verbose" <<< '
        let all = ./dev/dhrun/all-tests.dh
          "../dev/dhrun/assets/"
          "../resources/defaults/Cfg.dhall // { verbose=<Normal|Verbose|Debug>.Debug }"
          "../resources/examples/"
        in all.listen
      '
